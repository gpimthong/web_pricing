<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ใบรับ</title>
  <style>
    #container {
      display: flex;
      width: 100%;
      height: 500px;
    }

    .price-up {
      color: red;
    }

    .price-down {
      color: green;
    }

    .price-down,
    .price-up {
      font-weight: bold;
      /* border: 4px solid rgb(12, 125, 177); */
    }

    #table1,
    #table2 {
      overflow: auto;
      display: none;
    }

    #my-table1,
    #my-table2,
    #my-table3 {
      border-collapse: collapse;
      margin: auto;
      padding: 20px;
      /* border: 1px solid black; */
      max-width: 2480px;
      width: 100%;
    }


    td {
      width: fit-content;
      overflow: hidden;
      white-space: nowrap;
      margin: auto;
      padding: 5px 10px 5px 10px;

    }

    .grid-container {
      display: grid;
      grid-template-columns: auto auto;
      grid-template-rows: 300px 200px;
      gap: 5px;
      background-color: #ffffff;
      padding: 5px;
      margin: 20px auto 20px;
    }

    .grid-container>div {
      background-color: rgba(255, 255, 255, 0.8);
      text-align: center;
      padding: 5px 0;
      font-size: 1rem;
    }

    #table3 {
      grid-column-end: span 2;
      /* height: 100vh; */
      align-items: center;
      width: 100%;
      margin: 20px 15px 15px 20px;
    }

    #my-table3 {
      font-size: 1rem;
    }

    .item-cell {
      text-align: left;
      width: 10rem;

    }

    .margin_td {
      box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      font-size: 1rem;
      border-top-style: hidden;
      border-left-style: hidden;
      border-right-style: hidden;
      border-bottom-style: hidden;

    }

    input.margin_td,
    input#margin {
      text-align: center;
      width: 3rem;
    }

    #topic {
      font-size: 2rem;
      margin: 0px 25px;
    }

    span {
      margin: 0px 25px;
    }

    @media print {

      .no-print,
      .no-print * {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <!-- START HTML code -->
  <input class="no-print" type="file" id="inputfiles" multiple onchange="readFiles(event)" />
  <label class="no-print" for="margin">Margin</label>
  <input class="no-print" id="margin" value="10" type="number" onkeypress="return isNumberKey(event)" />
  <hr class="no-print">



  <p><span id="topic">ทำราคาขาย</span>เลขบิล :<span id="otfb"></span> วันที่ : <span id="current-date"></span><span
      id="fname"></span></p>

  <div class="grid-container" id="-container">
    <div class="no-print" id="table1" name="data1"></div>
    <div class="no-print" id="table2" name="data2"></div>
    <div id="table3" name="data3">

    </div>
  </div>
  <!-- END HTML code -->
  <!--





  -->
  <!-- START JavaScript code -->
  <script>



    const file_1_header = [1, 14, 15, 18, 20, 21]; // Array.from(Array(50).keys()); //[1, 2, 3, 4];
    const file_2_header = [1, 2, 4, 5]; //[Array.from(Array(50).keys()); //1, 2, 3, 4, 5];


    function isNumberKey(evt) {
      var charCode = (evt.which) ? evt.which : evt.keyCode
      if (charCode > 31 && (charCode != 46 && (charCode < 48 || charCode > 57)))
        return false;
      return true;
    }

    addDate();

    let table_data = {};
    table_data.data0 = {};
    table_data.data1 = {};

    var linesRead = 0;

    let items = [];


    function readFiles(event) {
      // get the list of files objects
      let files = event.target.files;

      // check if there are exactly two files selected
      if (files.length != 2) {
        alert("เลือก 2 ไฟล์เท่านั้น");
        return;
      }

      let file1_size = files[0].size;
      let file2_size = files[1].size;

      let file_array = [];

      // create an array to store all texts
      let texts = [];

      //Separate verion to avoid having issue of swapping file
      let item_list = [];  //store few item for daily incoming goods
      let all_list = []; //store all goods in store

      // create an array to store all readers
      let readers = [];


      // loop through each file object and create a reader for each one
      for (let i = 0; i < files.length; i++) {
        readers[i] = new FileReader();
      }




      //var tsv is the TSV file with headers
      function tsvJSON(tsv) {

        var lines = tsv.split("\n");

        var result = [];

        var headers = lines[0].split("\t");

        for (var i = 1; i < lines.length; i++) {

          var obj = {};
          var currentline = lines[i].split("\t");

          for (var j = 0; j < headers.length; j++) {
            obj[headers[j]] = currentline[j];
          }

          result.push(obj);

        }

        return JSON.stringify(result); //JSON

      }

      readers[0].onload = function (e) {
        item_list = e.target.result;
        //console.log(tsvJSON(item_list));
        checkAllLoaded();
      };

      readers[1].onload = function (e) {
        all_list = e.target.result;
        checkAllLoaded();
      };

      if (file1_size < file2_size) {
        readers[0].readAsText(files[0]);
        readers[1].readAsText(files[1]);
      }
      else {
        readers[0].readAsText(files[1]);
        readers[1].readAsText(files[0]);
      }



      // define a function to check if all files are loaded and then display them in separate tables
      function checkAllLoaded() {
        if (item_list.length != 0 && all_list.length != 0) {
          texts.push(item_list);
          texts.push(all_list);
          displayTables();
        }
      }

      // define a function to display each text in a separate table
      function displayTables() {
        // loop through each text
        for (let i = 0; i < texts.length; i++) {
          // get the corresponding table element by its id
          let table = document.getElementById("table" + (i + 1));

          // Create a table element
          var mytable = document.createElement("table");

          // Create a table head element
          var thead = document.createElement("thead");
          var tbody = document.createElement("tbody");

          // Append the head to the table
          mytable.appendChild(thead);
          // Append the body to the table
          mytable.appendChild(tbody);

          // Set the id attribute of the table
          mytable.setAttribute("id", "my-table" + (i + 1));

          // split the text by line breaks
          let lines = texts[i].split("\n");

          // loop through each line
          let n = 0;

          for (let j = 0; j < lines.length; j++) {
            //linesRead++;
            //progress.value = linesRead / lines.length;

            // split the line by tabs
            let cells = lines[j].split("\t");

            if (cells.length > 1) {
              //Keeping barcode of a new items
              if (i == 0 && j > 0) {
                //store item of today
                items.push(cells[14]); //barcode at column-14
              }
              //-----------------------

              if (
                i == 0 ||
                (i == 1 && j == 0) ||
                (i == 1 && items.includes(cells[1]))
              ) {
                //Create ID Column on the left most
                // Add some content to the head cells
                //cell1.innerHTML = j;

                //This is just for JSON object
                if (i == 0) {
                  table_data.data0[j] = cells;
                }

                if (i == 1) {
                  //cell1.innerHTML = n + "-" + j;
                  table_data.data1[n] = cells;
                  n++;
                }
                //-------------------------

                // loop through each cell
                c = 0;

                if (j == 0) {
                  var headRow = thead.insertRow(0);
                  headRow.insertCell(0);
                } else {
                  var bodyRow = tbody.insertRow(-1);
                  var bodyCell0 = bodyRow.insertCell(0);
                  bodyCell0.innerHTML = j;
                  if (i == 1) bodyCell0.innerHTML = String(n - 1) + "-" + j;
                }

                for (let k = 0; k < cells.length; k++) {
                  //this is header
                  if (j == 0) {
                    if (
                      (file_1_header.includes(k) && i == 0) ||
                      (file_2_header.includes(k) && i == 1)
                    ) {

                      // Create two rows for the body
                      var cell1 = headRow.insertCell(-1);
                      cell1.innerHTML = String(k) + "_" + cells[k];
                    }
                  } else {
                    if (
                      (file_1_header.includes(k) && i == 0) ||
                      (file_2_header.includes(k) && i == 1)
                    ) {
                      var bodyCell1 = bodyRow.insertCell(-1);

                      bodyCell1.innerHTML = cells[k];
                      //add id to old price
                      if (i == 1 && k == 5) {
                        bodyCell1.setAttribute("id", cells[1]);

                      }
                      //add id to old sell
                      if (i == 1 && k == 4) {
                        bodyCell1.setAttribute("id", 'sell-' + cells[1]);

                      }
                    }
                  }
                }
              }
            }

          }
          // Append the table to the document body
          table.appendChild(mytable);
        }

        /***
         *  prepare for table3
         * **/
        let table3 = document.getElementById("table3");
        // Create a table element
        var mytable3 = document.createElement("table");

        // Create a table head element
        var thead3 = document.createElement("thead");
        var tbody3 = document.createElement("tbody");
        // Append the head to the table
        mytable3.appendChild(thead3);
        // Append the body to the table
        mytable3.appendChild(tbody3);

        // Set the id attribute of the table
        mytable3.setAttribute("id", "my-table3");
        const dMargin = parseFloat(document.getElementById("margin").value);

        var headRow = thead3.insertRow(0);
        var cell1 = headRow.insertCell(0);
        cell1.innerHTML = "ลำดับ";
        headRow.insertCell(-1).innerHTML = "รหัส";
        headRow.insertCell(-1).innerHTML = "รายการ";
        headRow.insertCell(-1).innerHTML = "รวมเงิน";
        headRow.insertCell(-1).innerHTML = "รับ";
        headRow.insertCell(-1).innerHTML = "ทุนใหม่";
        headRow.insertCell(-1).innerHTML = "ทุนเก่า";
        headRow.insertCell(-1).innerHTML = "%";
        headRow.insertCell(-1).innerHTML = "ขายใหม่";
        headRow.insertCell(-1).innerHTML = "ขายเก่า";
        var n = 0;
        for (item in table_data.data0) {
          if (n > 0) {
            var bodyRow = tbody3.insertRow(-1);
            var barcode = table_data.data0[item][14];

            bodyRow.insertCell(-1).innerHTML = n;
            bodyRow.insertCell(-1).innerHTML = barcode; // "รหัส";
            var item_cell = bodyRow.insertCell(-1);
            item_cell.innerHTML = table_data.data0[item][15]; // "รายการ";
            item_cell.setAttribute("class", "item-cell");

            bodyRow.insertCell(-1).innerHTML = parseFloat(
              table_data.data0[item][21]
            ).toFixed(2); // "รวมเงิน";
            bodyRow.insertCell(-1).innerHTML = parseFloat(
              table_data.data0[item][18]
            ).toFixed(0); // "รับ";

            let id_old_base = document.getElementById(barcode);
            let id_old_sell = document.getElementById('sell-' + barcode);

            if (id_old_base) {
              var old_base = parseFloat(id_old_base.innerHTML).toFixed(2);
            } else {
              var old_base = -999;
            }
            if (id_old_sell) {
              var old_sell = parseFloat(id_old_sell.innerHTML).toFixed(2);
            } else {
              var old_sell = -999;
            }

            var new_base = parseFloat(table_data.data0[item][20]).toFixed(2);

            var new_sell = (new_base * (1 + dMargin * 0.01)).toFixed(2);
            //var old_sell = (old_base * (1 + dMargin * 0.01)).toFixed(2);


            var bodyCell1 = bodyRow.insertCell(-1);
            bodyCell1.innerHTML = new_base; // "ทุนใหม่";
            bodyCell1.setAttribute("id", "new_base-" + barcode);

            bodyCell1 = bodyRow.insertCell(-1)
            bodyCell1.innerHTML = old_base; // "ทุนเก่า";
            bodyCell1.setAttribute("id", "old_base-" + barcode);

            var celledit = bodyRow.insertCell(-1);


            var input = document.createElement('input');
            input.setAttribute("class", "margin_td");
            input.setAttribute("onkeypress", "return isNumberKey(event)");
            //type = "number" onkeypress = "return isNumberKey(event)" 

            input.type = "number";
            input.value = dMargin;
            input.setAttribute("id", "mg-" + barcode);
            celledit.appendChild(input);


            var bodyCell2 = bodyRow.insertCell(-1);
            bodyCell2.innerHTML = Math.round(new_sell); // "ขายใหม่";
            bodyCell2.setAttribute("id", "new_sell-" + barcode);


            bodyCell2 = bodyRow.insertCell(-1);
            bodyCell2.innerHTML = Math.round(old_sell); // "ขายเก่า";
            bodyCell2.setAttribute("id", "old_sell-" + barcode);

          }
          n++;
        }

        table3.appendChild(mytable3);


        /**
         *-----------------------------
         **/

        syncScroll();
        addevent();

        let re = /\d+\/\d+\/\d{4}/g;

        document.getElementById("current-date").innerHTML = re.exec(table_data.data0[2][1]);
        document.getElementById("otfb").innerHTML = table_data.data0[2][2];
      }

      function syncScroll() {
        var table1 = document.getElementById("table1");
        var table2 = document.getElementById("table2");

        var scrollHandler = function (e) {
          var source = e.target;
          var target = source == table1 ? table2 : table1;
          target.scrollTop = source.scrollTop;
        };

        table1.addEventListener("scroll", scrollHandler);
        table2.addEventListener("scroll", scrollHandler);
      }





    }

    function addevent() {

      mtd = document.querySelectorAll('.margin_td');


      mtd.forEach(function (element) {
        element.addEventListener("change", function () {
          //console.log(element.id);
          var obj = document.getElementById('old_base-' + element.id.slice(3, element.id.length));
          var old_base = parseFloat(obj.innerHTML)

          obj = document.getElementById('new_base-' + element.id.slice(3, element.id.length));
          var new_base = parseFloat(obj.innerHTML);

          //old.innerHTML = 1+(element.value * 0.01)
          //console.log(old_base + " - " + new_base);

          //obj = document.getElementById('old_sell-'+element.id.slice(3,element.id.length));
          //obj.innerHTML = Math.round(old_base * (1+(element.value*0.01)));

          obj = document.getElementById('new_sell-' + element.id.slice(3, element.id.length));
          obj.innerHTML = Math.round(new_base * (1 + (element.value * 0.01)));


        });
      })

    }

    function addDate() {
      n = new Date();
      y = 543 + n.getFullYear();
      m = n.getMonth() + 1;
      d = n.getDate();
      document.getElementById("current-date").innerHTML = d + "/" + m + "/" + y;
    }


  </script>
</body>

</html>